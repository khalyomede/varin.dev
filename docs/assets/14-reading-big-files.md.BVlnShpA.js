import{_ as i,c as a,o as e,ae as n}from"./chunks/framework.CB66Z1r5.js";const c=JSON.parse('{"title":"14. Reading big files","description":"","frontmatter":{},"headers":[],"relativePath":"14-reading-big-files.md","filePath":"14-reading-big-files.md"}'),l={name:"14-reading-big-files.md"};function t(h,s,p,r,k,o){return e(),a("div",null,[...s[0]||(s[0]=[n(`<h1 id="_14-reading-big-files" tabindex="-1">14. Reading big files <a class="header-anchor" href="#_14-reading-big-files" aria-label="Permalink to &quot;14. Reading big files&quot;">​</a></h1><h2 id="classic-approach" tabindex="-1">Classic approach <a class="header-anchor" href="#classic-approach" aria-label="Permalink to &quot;Classic approach&quot;">​</a></h2><p>When opening a big file to perform any process on it, like reading a big CSV report, the virtual memory will be consumed by the same amount of bytes as the file weights.</p><p>As the virtual memory of the server that host your V program are limited, and given your server may serve multiple client requesting to open heavy files at the same time, you risk to encounter out of memory errors causing your server to shut down.</p><div class="language-v vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">v</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">module</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> main</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> os</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { read_file }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">fn</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> main</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  payments </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> read_file</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;payments.jsonl&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><ul><li><a href="https://modules.vlang.io/os.html#read_file" target="_blank" rel="noreferrer"><code>read_file</code></a> documentation</li></ul><p>In this example, if the file weights 2 Gb, your server will have to consume 2 Gb of virtual memory.</p><p>If another client reads the file at the same time, or if the server is busy using this memory for another work (like reading SQL rows or performing backups), this will put your server at risk of an unexpected shutdown.</p><h2 id="buffered-chunked-approach" tabindex="-1">Buffered / chunked approach <a class="header-anchor" href="#buffered-chunked-approach" aria-label="Permalink to &quot;Buffered / chunked approach&quot;">​</a></h2><p>Rather than reading the file in its entirety, you should read line by line instead.</p><p>Reading line by line offer the advantage of consuming only the necessary amount of bytes to hold a single line.</p><p>If you read a file that weights 2 Gb which contains payments informations on each line, and each lines weight 48 bytes, your server will only consume 48 bytes at the maximum, instead of 2 Gb.</p><p>This dramatically reduces the chances your server shuts down because of lack of virtual memory. This also allows your server to serve more clients since it is able to process big files in chunks.</p><div class="language-v vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">v</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">module</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> main</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> io</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { new_buffered_reader }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> os</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { open_file }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">fn</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> main</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  file </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> open_file</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;payments.jsonl&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  payments </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> new_buffered_reader</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(reader: file)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    payment </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> payments.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">read_line</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">or</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      break</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><ul><li><a href="https://modules.vlang.io/io.html#new_buffered_reader" target="_blank" rel="noreferrer"><code>new_buffered_reader</code></a> documentation</li><li><a href="https://modules.vlang.io/os.html#open_file" target="_blank" rel="noreferrer"><code>open_file</code></a> documentation</li></ul><p>The drawback of using a buffered approach is your program takes more time because it has to open and buffer a stream for each new lines.</p>`,16)])])}const g=i(l,[["render",t]]);export{c as __pageData,g as default};
